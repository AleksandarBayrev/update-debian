#!/bin/bash
# Script to update Debian systems with optional backports support

# Configurations
CONFIG_FILE="/etc/update-debian/configuration"
CONFIG_DIR="/etc/update-debian"

handle_interrupt() {
    echo ""
    echo "Script interrupted by user. Exiting..."
    exit 130
}

trap handle_interrupt SIGINT SIGTERM

set_backports_pref() {
    sudo mkdir -p "$CONFIG_DIR"
    echo "USE_BACKPORTS=$1" | sudo tee "$CONFIG_FILE" > /dev/null
    echo "Configuration updated: USE_BACKPORTS=$1"
    echo "Please re-run the script use the applied changes."
    exit 0
}

case "$1" in
    --enable-backports)
        set_backports_pref "true"
        ;;
    --disable-backports)
        set_backports_pref "false"
        ;;
esac

distroCheckOne=$(cat /etc/os-release | grep -i "NAME=\"Debian GNU/Linux\"")
distroCheckTwo=$(cat /etc/debian_version 2>/dev/null)

if [[ -z "$distroCheckOne" || -z "$distroCheckTwo" ]]
then
    echo "Distribution is not Debian, exiting..."
    exit 0
fi

if [ "$(id -u)" != "0" ];
then
   echo "This script must be run as root. Try 'sudo update-debian'" 1>&2
   exit 1
fi

if [ ! -f "$CONFIG_FILE" ]; then
    echo "Configuration file not found."
    read -p "Would you like to enable Debian Backports for future updates? (y/n) " pref_choice
    sudo mkdir -p "$CONFIG_DIR"
    if [[ "$pref_choice" =~ ^[Yy]$ ]]; then
        echo "USE_BACKPORTS=true" | sudo tee "$CONFIG_FILE" > /dev/null
    else
        echo "USE_BACKPORTS=false" | sudo tee "$CONFIG_FILE" > /dev/null
    fi
fi

source "$CONFIG_FILE"
if [[ "$USE_BACKPORTS" == "true" ]]; then
    echo "--- Mode: Debian Backports ENABLED ---"
else
    echo "--- Mode: Standard Debian Updates (Backports Disabled) ---"
fi

echo 'Performing system update'
sudo apt update

if ! command -v lsb_release &> /dev/null;
then
    sudo apt install lsb-release -y
fi

if [[ "$USE_BACKPORTS" == "true" ]] && command -v lsb_release &> /dev/null;
then
    CODENAME=$(lsb_release -cs)
    
    # Add repository if missing
    if ! grep -r "backports" /etc/apt/sources.list* &> /dev/null;
    then
        echo "Adding backports to /etc/apt/sources.list.d/backports.list..."
        echo "deb http://deb.debian.org/debian ${CODENAME}-backports main contrib non-free" | sudo tee /etc/apt/sources.list.d/backports.list
        sudo apt update
    fi
    
    echo "Performing backports upgrade for $CODENAME."
    sudo apt dist-upgrade -t "${CODENAME}-backports" -y
else
    echo "Backports disabled or unavailable. Performing standard distribution upgrade."
    sudo apt dist-upgrade -y
fi

sudo apt autoremove -y

if command -v flatpak &> /dev/null
then
    echo 'Performing flatpaks update'
    flatpak update -y
fi

if command -v dkms &> /dev/null
then            
    echo 'Checking DKMS modules'
    sudo dkms autoinstall
fi

echo "Update complete."
REBOOT_RECOMMENDED=false
PROMPT_MSG="Do you want to reboot now?"

if [ -f /var/run/reboot-required ];
then
    echo "A reboot is recommended by the system."
    REBOOT_RECOMMENDED=true
    PROMPT_MSG="Do you want to reboot now? (reboot is recommended)"
fi

read -p "$PROMPT_MSG (y/n) " choice
case "$choice" in 
  y|Y ) 
    echo "Rebooting system..."
    sudo reboot
    ;;
  * ) 
    echo "Reboot deferred. Please reboot later."
    ;;
esac