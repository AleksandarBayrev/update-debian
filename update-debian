#!/bin/bash
handle_interrupt() {
    echo ""
    echo "Script interrupted by user. Exiting..."
    exit 130
}
trap handle_interrupt SIGINT SIGTERM

distroCheckOne=$(cat /etc/os-release | grep -i "NAME=\"Debian GNU/Linux\"")
distroCheckTwo=$(cat /etc/debian_version 2>/dev/null)

if [[ -z "$distroCheckOne" || -z "$distroCheckTwo" ]]
then
    echo "Distribution is not Debian, exiting..."
    exit 0
fi

if [ "$(id -u)" != "0" ]; then
   echo "This script must be run as root. Try 'sudo update-debian'" 1>&2
   exit 1
fi

echo 'Performing system update'
sudo apt update
sudo apt dist-upgrade -y

if command -v lsb_release &> /dev/null; then
    if grep -r "backports" /etc/apt/sources.list* &> /dev/null; then
        CODENAME=$(lsb_release -cs)
        echo "Backports detected. Performing backports upgrade for $CODENAME."
        sudo apt dist-upgrade -t "${CODENAME}-backports" -y
    fi
fi

sudo apt autoremove -y

if command -v flatpak &> /dev/null
then
    echo 'Performing flatpaks update'
    flatpak update -y
fi

if command -v dkms &> /dev/null
then            
    echo 'Checking DKMS modules'
    sudo dkms autoinstall
fi

echo "Update complete."

REBOOT_RECOMMENDED=false
PROMPT_MSG="Do you want to reboot now?"

if [ -f /var/run/reboot-required ]; then
    echo "A reboot is recommended by the system."
    REBOOT_RECOMMENDED=true
    PROMPT_MSG="Do you want to reboot now? (reboot is recommended)"
fi

read -p "$PROMPT_MSG (y/n) " choice
case "$choice" in 
  y|Y ) 
    echo "Rebooting system..."
    sudo reboot
    ;;
  * ) 
    echo "Reboot deferred. Please reboot later."
    ;;
esac